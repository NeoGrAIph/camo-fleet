# Анализ причин ошибки PR_END_OF_FILE_ERROR

## Контекст
При создании VNC-сессий в Camofleet первые открытия `https://bot.sannysoft.com` иногда завершаются ошибкой `PR_END_OF_FILE_ERROR`, тогда как последующие попытки успешны. Ниже разобраны предложенные объяснения причин проблемы.

## Объяснение 1
**Версия:** prewarm-серверы запускаются до применения переменных окружения (`MOZ_DISABLE_HTTP3`, `RUNNER_DISABLE_HTTP3`), поэтому Firefox стартует без нужных флагов.

**Проверка:**
- Скрипт запуска раннера экспортирует `MOZ_DISABLE_HTTP3` до запуска Python-процесса, если `RUNNER_DISABLE_HTTP3` включён (а в chart он включён по умолчанию).【F:docker/scripts/runner-entrypoint.sh†L22-L32】【F:runner/src/camoufox_runner/config.py†L25-L45】
- При создании каждого браузерного сервера (включая prewarm) метод `_launch_browser_server` добавляет `MOZ_DISABLE_HTTP3` в окружение дочернего процесса, если в настройках отключён HTTP/3.【F:runner/src/camoufox_runner/sessions.py†L800-L859】

**Вывод:** env переменные гарантированно присутствуют до старта prewarm-серверов. Объяснение 1 не подтверждается.

## Объяснение 2
**Версия:** prewarm-серверы используют постоянные профили и не очищаются, поэтому закэшированный Alt-Svc из прошлых сессий заставляет Firefox снова пытаться HTTP/3.

**Проверка:**
- Каждый prewarm-сервер создаётся с уникальным временным профилем через `tempfile.mkdtemp`, который удаляется при остановке сервера.【F:runner/src/camoufox_runner/sessions.py†L831-L931】
- Когда prewarmed ресурс забирается сессией, он не возвращается в пул: после завершения сессии `_shutdown_handle` закрывает сервер, что приводит к уничтожению профиля.【F:runner/src/camoufox_runner/sessions.py†L284-L318】【F:runner/src/camoufox_runner/sessions.py†L364-L374】【F:runner/src/camoufox_runner/sessions.py†L916-L931】
- Обновление пула создаёт **новые** процессы и профили, а не переиспользует прежние.【F:runner/src/camoufox_runner/sessions.py†L443-L485】

**Вывод:** профили prewarm-серверов очищаются и не передаются между сессиями. Объяснение 2 не подтверждается.

## Объяснение 3
**Версия:** хотя `network.http.altsvc.enabled` и `network.http.altsvc.https` отключаются, это происходит слишком поздно, и первые запросы успевают записать Alt-Svc.

**Проверка:**
- Указанные предпочтения (наряду с множеством HTTP/3-тумблеров) записываются в конфигурацию **до** запуска браузера, потому что Playwright получает `firefoxUserPrefs` в момент старта процесса. Это тот же код `_launch_browser_server`, что и для prewarm, поэтому других путей инициализации нет.【F:runner/src/camoufox_runner/sessions.py†L800-L859】
- Эти prefs задаются из `RunnerSettings.disable_http3`, который по умолчанию равен `True`, поэтому они активны даже для самых ранних запросов.【F:runner/src/camoufox_runner/config.py†L25-L45】

**Вывод:** предпочтения отключения Alt-Svc применяются до первого сетевого обращения. Объяснение 3 не подтверждается.

## Объяснение 4
**Версия:** текущая сборка Camoufox/Playwright не отключает все необходимые prefs; например, могли появиться новые настройки Alt-Svc.

**Проверка:**
- Код явно отключает как современные, так и устаревшие ключи `network.http.http3.*`, `network.dns.http3_echconfig.enabled`, `network.http.altsvc.enabled` и `network.http.altsvc.https`. Комментарии ссылаются именно на проблему с Cloudflare и `PR_END_OF_FILE_ERROR`, что показывает учёт известных регрессий в последних Firefox.【F:runner/src/camoufox_runner/sessions.py†L800-L820】
- Автотест `test_launch_browser_server_configures_http3_prefs` проверяет, что конфиг действительно содержит эти prefs и `MOZ_DISABLE_HTTP3=1`, то есть отсутствие новых тумблеров не воспроизводится хотя бы на текущей версии зависимостей.【F:runner/tests/test_sessions.py†L130-L150】

**Вывод:** существующий код покрывает известные HTTP/3/Alt-Svc prefs, и тесты подтверждают их установку. Дополнительные prefs не выявлены, поэтому объяснение 4 не подтверждается.

## Объяснение 5
**Версия:** пул prewarm-серверов организован циклически, поэтому «грязный» сервер используется через одну сессию, вызывая чередование ошибка/успех.

**Проверка:**
- Пул реализован стеком (`list.pop()`), поэтому каждый prewarm-ресурс выдаётся максимум один раз; после выдачи список уменьшается.【F:runner/src/camoufox_runner/sessions.py†L433-L441】
- Как только ресурс использован, фоновой задачей создаётся новый сервер, а старый закрывается при завершении сессии (см. вывод для объяснения 2). Это исключает циклическое повторное использование того же процесса.【F:runner/src/camoufox_runner/sessions.py†L284-L318】【F:runner/src/camoufox_runner/sessions.py†L443-L485】

**Вывод:** prewarm-пул не рециклирует один и тот же процесс через сессии. Объяснение 5 не подтверждается.

## Общий итог
Все рассмотренные объяснения не подтверждаются исходным кодом: HTTP/3 и Alt-Svc отключаются до старта браузера, профили prewarm-серверов уничтожаются после использования, а пул не переиспользует «грязные» экземпляры.

## Истинная причина

Firefox 127+ научился поднимать HTTP/3‑соединения не только через заголовок `Alt-Svc`, но и через DNS‑ответы типа HTTPS (SVCB). Даже при отключённом Alt-Svc такие ответы (`alpn="h3"`) заставляли prewarm-процессы обращаться к QUIC‑эндпоинтам Cloudflare, что в среде без UDP заканчивалось `PR_END_OF_FILE_ERROR`. Профиль prewarm-процесса сохранял флаг неуспешного QUIC‑рукопожатия, и каждый раз, когда сессия забирала этот prewarm, первый переход на `https://bot.sannysoft.com` завершался сбоем.

Добавлен запрет на использование HTTPS RR как источника Alt-Svc (`network.dns.use_https_rr_as_altsvc=false`). Теперь резолвер Firefox остаётся на HTTP/2, и страницы Cloudflare открываются стабильно в любой новой сессии.【F:runner/src/camoufox_runner/sessions.py†L806-L823】【F:runner/tests/test_sessions.py†L141-L154】
