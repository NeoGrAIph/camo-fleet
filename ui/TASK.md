# Техническое задание (ТЗ) — Runner‑UI фронтенд

## 1. Введение

**Цель:** разработать веб‑интерфейс для управления сессиями браузерного Runner’а (Camoufox/Chromium), по мотивам Selenoid‑UI: просмотр активных сессий в реальном времени, создание «ручных» сессий, просмотр артефактов (HAR/видео/скриншоты), live‑экран (опционально VNC), логи, завершение сессий и базовые настройки.

**Контекст:** фронтенд работает поверх Backend API Runner’a (описанного ранее), использует SSE для live‑обновлений и REST для команд.

## 2. Пользовательские роли
* **Admin:** полный доступ (все сессии, Kill, настройки UI, системные метрики).

## 3. Основные сценарии (User Flows)

1. **Просмотр живого списка сессий** → фильтр/поиск → открыть детали → изучить логи/артефакты → вернуться.
2. **Manual Run** → форма опционально (отпечаток/HAR/прокси/запись видео) → запуск → мгновенное появление в списке → наблюдение/управление.
3. **Завершение сессии** → подтверждение → статус меняется на TERMINATING → DEAD → артефакты доступны.
4. **Live‑просмотр/управление** (если включён): открыть поток → управление(noVNC)/наблюдение(noVNC).
5. **Скачивание артефактов**: видео/HAR/скриншоты из вкладки Artifacts.
6. **Мониторинг**: основные показатели + индикатор состояния SSE.

## 4. Страницы/экраны

### 4.1 Login

* Поля: username / password (или кнопка SSO).
* Ошибки: неверные учётные данные, истёкшая сессия.

### 4.2 Dashboard / Sessions

* Карточки: `total`, `used`, `queued`, `pending`, ошибки.
* Таблица сессий (виртуальный скролл):

  * Колонки: **ID**, **Engine**, **Version**, **Mode**, **Profile** (auto/hybrid/manual), **Region/Proxy**, **VNC**, **StartedAt**, **LastActivity**, **TTL left**, **Status**, **Labels**, **Actions**.
  * Фильтры: по статусу, по движку/версии, по ярлыкам (labels), по владельцу, по периоду дат.
  * Поиск по ID / имени / тегам.
* Действия в таблице: View, Kill (по роли), Copy wsEndpoint, Open VNC (если доступно).
* Индикатор соединения SSE (Online / Reconnecting … / Offline).

### 4.3 Session Details

* Шапка: ID, статус, owner, labels, быстрые действия (Kill, Copy ws, Open VNC, Download HAR/Video).
* Вкладки:
  * **Overview:** URL, region/proxy, TTL таймер, текущий Engine/Version, Mode, Profile, кнопка «Рестарт вьюера» (только UI, не трогает браузер).
  * **Timeline:** список шагов/навигаций с таймингами.
  * **Console:** `console.log/warn/error` (+ фильтры/поиск).
  * **Network:** компактный список запросов (метод, URL, статус, длительность, размер) + ссылка на HAR; фильтры по статусам/методам/поиску.
  * **Artifacts:** список файлов, предпросмотр скринов/видео (в браузере), кнопки Download.
  * **Fingerprint:** JSON‑viewer итогового отпечатка (если `fingerprint_dump` доступен).
  * **Metrics:** графики p50/p95 навигации, трафик, ошибки по типам.
* (Опционально) **Live Screen**: встроенный noVNC, fullscreen, scaling, snapshot.

### 4.4 Manual Run (Wizard)

* Шаг 1: Engine/Version, Mode (direct/managed), Labels (по умолчанию `manual=true`).
* Шаг 2: Fingerprint — **mode**: auto / hybrid / manual; `constraints` (os/region/screen\_max), `overrides`, `seed`.
* Шаг 3: Proxy/Cookies, Recording (HAR/Video), VNC (optional), TTL, Permissions.
* Подтверждение → запуск → редирект на Session Details.
* Валидации совместимости (soft warnings / blocking errors).

### 4.5 Settings / Profile (минимум)

* Язык интерфейса (ru/en), тема (light/dark), формат времени (локаль/24‑часовой), автосохранение фильтров.

### 4.6 System / Errors

* 403, 404, 500 — дружелюбные страницы.
* Страница «SSE Offline» с ретраями.

## 5. Компоненты UI

* Таблица сессий (виртуализированная, фиксируемые колонки, сохранение вида).
* Фильтры и теги (labels) + редактор ярлыков.
* Badge статуса (цвета по состояниям) и бейджи для Mode/Engine.
* TTL таймер (live countdown).
* Индикатор SSE (dot + тултип с последним Event‑ID/ошибкой).
* Кнопки: View, Kill (с подтверждением), Copy (wsEndpoint/VNC URL), Download.
* JSON Viewer (foldable) для fingerprint\_dump/логов событий.
* noVNC виджет (опционально, как lazy‑подключаемый компонент).

## 6. API интеграция

### 6.1 SSE `/events`

* События: `snapshot`, `session_created`, `session_updated`, `session_deleted`, `metrics_update`, `queue_update`.
* Поведение клиента:
  * Запрос `GET /status` при монтировании; затем подписка на `/events`.
  * Применение диффов к локальному состоянию.
  * Автопереподключение (экспоненциальный backoff), учёт `Last-Event-ID`.

### 6.2 REST

* `GET /status` — агрегаты и короткая форма сессий (для Dashboard).
* `GET /sessions` — постраничный список (детальнее, с фильтрами/сортировкой).
* `GET /sessions/{id}` — полные детали (артефакты, fingerprint\_dump\*).
* `POST /sessions` — Manual Run.
* `DELETE /sessions/{id}` — завершение.
* `GET /sessions/{id}/logs` — stream=false (страница), stream=true (live, где возможно).
* `GET /sessions/{id}/artifacts` — список файлов с presigned‑URL.
* `GET /vnc/{id}` — WebSocket (опционально, защищённый одноразовым токеном).

> \*Загрузка/скачивание больших файлов — через прямые ссылки на хранилище (редирект).

## 7. Состояние и архитектура фронтенда

* **State management:** хранилище (например, Zustand/Redux) + слой репозитория для API + нормализация сущностей (sessionsById).
* **SSE Store:** отдельный стор с очередью событий, редьюсеры для «дифф‑применения», метрики канала.
* **Routing:** SPA‑маршруты `/`, `/sessions`, `/sessions/:id`, `/run`, `/settings`.
* **Error boundary** для критических ошибок.

## 8. Безопасность

* Auth: JWT/OIDC; хранение access‑token в memory (не в localStorage), refresh по бекэнду/UI таймеру.
* Роли: UI скрывает/блокирует недоступные действия; бэкенд также проверяет права.
* CSRF не требуется для чистого API с Bearer‑токеном; для cookie‑сессий — включить.
* Санитайзинг/экранирование логов и текстов из бэкенда.

## 9. Нефункциональные требования

* **Производительность:** TTI < 2.5 с при холодном старте (LAN), обновления SSE < 1 с задержки; таблица 5k+ записей с виртуализацией.
* **Адаптивность:** ≥ 1280px (основной), поддержка 1024px; мобильная версия опциональна.
* **Доступность:** WCAG 2.1 AA (контраст, фокус‑стили, клавиатурная навигация, aria‑метки).
* **Локализация:** ru/en; формат времени — локаль пользователя, дефолт Europe/Helsinki.
* **Темизация:** light/dark; сохранение выбора пользователя.
* **Браузеры:** последние версии Chrome/Firefox/Edge, Safari 2 последних мажорных.

## 10. Телеметрия

* События: LoginSuccess/Fail, ManualRunCreate/Fail, SessionView, KillClick/Confirm, SSEReconnect, ArtifactDownload, VNCOpen.
* Трассировка: корелляция с session\_id; sampling регулируемый.

## 11. Тестирование и приёмка

* **Unit:** компоненты таблицы/фильтров/индикаторов.
* **Integration:** флоу Manual Run, просмотр деталей, скачивание артефактов.
* **E2E:** мок‑сервер (MSW/Playwright) — сценарии создания/обновления/завершения, обрыв SSE, права ролей.
* **Acceptance (MVP):**

  * live‑обновления без перезагрузки;
  * Manual Run создаёт сессию, она видна в списке ≤ 2 c;
  * Kill меняет статус ≤ 5 c;
  * артефакты загружаются;
  * роли соблюдаются;
  * UI стабилен к обрывам SSE.

## 12. Среда/конфигурация

* ENV: `VITE_API_BASE_URL`, `VITE_VNC_ENABLED`, `VITE_SSE_PATH`, `VITE_AUTH_PROVIDER`.
* Сборка: Vite + TypeScript (или аналогичный), кэширование ассетов, code‑splitting.

## 13. Вопросы/открытые пункты

* VNC по умолчанию включён? Требуется запись live‑стрима или достаточно видео по завершении?
* Нужны ли «маскировки» в видео/HAR (PII‑safe) на стороне UI (замыливать)?
* Форма Manual Run: какие поля обязательны в `fingerprint.overrides` (минимум/максимум)?
* Допускать ли редактирование labels у чужих сессий (по роли)?

## 14. Вне рамок (Out of Scope)

* Редактирование уже идущего отпечатка в живой сессии.
* Полноправный редактор DSL‑сценариев в UI (в MVP — только просмотр и базовый JSON‑редактор для Managed команд).

## 15. Гайд по стилю

* Современный минимализм, акцент на контраст и читаемость.
* Компоненты: таблицы (фиксированные заголовки), карточки, модальные окна, дропдауны, теги, бейджи, индикаторы состояний, спиннеры/скелетоны.
* Цвета статусов: READY (primary), BUSY (amber), IDLE (blue‑gray), TERMINATING (purple), DEAD (gray), ERROR (red).
